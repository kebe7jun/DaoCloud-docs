name: Release OpenAPI Doc

on:
  workflow_dispatch:
    inputs:
      product:
        description: 'Product'
        required: true
        default: 'ghippo'
        type: choice
        options:
          - mspider
          - ghippo
          - kpanda
      version:
        description: 'Version of api'
        required: true
        type: string
      swagger_json: 
        description: JSON format swagger
        required: true
        type: string

jobs:
  add-openapi-doc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Start Proxy
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -x
          p=${{ github.event.inputs.product }}
          d=docs/zh/docs/openapi/${{ github.event.inputs.product }}
          v=${{ github.event.inputs.version }}
          mkdir -p ${d}
          if [ -f ${d}/${v}.md ]; then
            echo "file already exists"
            exit 1
          fi
          if [ ! -f ${d}/index.md ]; then
            cat > ${d}/index.md <<EOF
          # 全局管理 OpenAPI
          - [版本 ${v}](./${v}.md)
          EOF
          else
            echo "- [版本 ${v}](./${v}.md)" >> ${d}/index.md
          fi
          echo "# <swagger-ui src=${v}.json>" > ${d}/${v}.md
          cat > ${d}/${v}.json <<EOF
          ${{ github.event.inputs.swagger_json }}
          EOF
          git checkout -b feature/add-${p}-${v}-api-doc
          git status
          git add .
          git config user.email "mspider-bot@7jun.cc"
          git config user.name "mspider-bot"
          git commit -m "Add ${p} version ${v} OpenAPI doc"
          git push origin feature/add-${p}-${v}-api-doc 
          gh pr create --title "Add ${p} version ${v} OpenAPI doc" -R kebe7jun/DaoCloud-docs
          gh pr list
